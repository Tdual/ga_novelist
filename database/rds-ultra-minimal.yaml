AWSTemplateFormatVersion: '2010-09-09'
Description: 'GA Novelist RDS - è¶…æœ€å°æ§‹æˆï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ï¼‰'

Parameters:
  DBMasterPassword:
    Description: Database password
    Type: String
    NoEcho: true
    MinLength: 8
    MaxLength: 41
    Default: GaNovelist2024!  # é–‹ç™ºç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæœ¬ç•ªã§ã¯å¤‰æ›´å¿…é ˆï¼‰

Resources:
  # æœ€å°é™ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: GA Novelist RDS SG (ultra minimal)
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 0.0.0.0/0  # å…¨é–‹æ”¾ï¼ˆé–‹ç™ºå°‚ç”¨ï¼‰

  # RDSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆè¶…æœ€å°æ§‹æˆï¼‰
  DBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete  # ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚‚ä½œã‚‰ãªã„
    Properties:
      DBInstanceIdentifier: ga-novelist-ultra-minimal
      DBName: ga_novelist
      
      # PostgreSQLæœ€å°æ§‹æˆ
      Engine: postgres
      EngineVersion: '15.4'
      DBInstanceClass: db.t3.micro
      
      # ========================================
      # ğŸ’° ç©¶æ¥µã®ã‚³ã‚¹ãƒˆå‰Šæ¸›è¨­å®š
      # ========================================
      
      # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€å°
      AllocatedStorage: 20  # æœ€å°å€¤
      StorageType: gp2      # æœ€å®‰
      StorageEncrypted: false
      
      # èªè¨¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
      MasterUsername: postgres
      MasterUserPassword: !Ref DBMasterPassword
      
      # ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆVPNä¸è¦ï¼‰
      PubliclyAccessible: true
      
      # ========================================
      # ğŸ”¥ å…¨ã¦ã®è¿½åŠ æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–
      # ========================================
      
      # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œå…¨ç„¡åŠ¹
      BackupRetentionPeriod: 0  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—
      
      # ç›£è¦–ç„¡åŠ¹
      EnablePerformanceInsights: false
      MonitoringInterval: 0  # CloudWatchç›£è¦–ãªã—
      
      # ãƒ­ã‚°å‡ºåŠ›ç„¡åŠ¹
      EnableCloudwatchLogsExports: []
      
      # è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç„¡åŠ¹
      AutoMinorVersionUpgrade: false
      
      # ãƒãƒ«ãƒAZç„¡åŠ¹
      MultiAZ: false
      
      # å‰Šé™¤ä¿è­·ç„¡åŠ¹
      DeletionProtection: false
      
      # ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æœ€çŸ­
      PreferredMaintenanceWindow: 'sun:18:00-sun:18:30'

Outputs:
  QuickStart:
    Description: ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰
    Value: !Sub |
      ========================================
      ğŸš€ æ¥ç¶šæ–¹æ³•
      ========================================
      
      1. psqlã§æ¥ç¶š:
      psql -h ${DBInstance.Endpoint.Address} -U postgres -d ga_novelist
      
      2. Juliaã‹ã‚‰æ¥ç¶š:
      using LibPQ
      conn = LibPQ.Connection("postgresql://postgres:${DBMasterPassword}@${DBInstance.Endpoint.Address}/ga_novelist")
      
      3. åˆæœŸåŒ–:
      psql -h ${DBInstance.Endpoint.Address} -U postgres -d ga_novelist -f database/01_create_schema.sql
      
      ========================================
      ğŸ’° æœˆé¡ã‚³ã‚¹ãƒˆ: ç´„$12ï¼ˆç´„1,800å††ï¼‰
      ========================================
      - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: $12.41
      - ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: $2.30
      - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: $0ï¼ˆç„¡åŠ¹ï¼‰
      - åˆè¨ˆ: ç´„$14.71/æœˆ
      
      ========================================
      âš ï¸ æ³¨æ„äº‹é …
      ========================================
      - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ï¼ˆãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ãƒªã‚¹ã‚¯ã‚ã‚Šï¼‰
      - ç›£è¦–ãªã—ï¼ˆéšœå®³æ¤œçŸ¥ã§ããªã„ï¼‰
      - å…¨ä¸–ç•Œã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
      - é–‹ç™ºå°‚ç”¨ï¼ˆæœ¬ç•ªä½¿ç”¨å³ç¦ï¼‰